name: Terraform-Infra-Workflow
on: 
  workflow_dispatch

defaults:
  run:
    working-directory: environments/dev
    
permissions:
  id-token: write
  contents: read
  
jobs:
  planning-job:
    runs-on: self-hosted
    name: first job
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: '9cd2e95c-0ae3-48fa-b642-ca15ee3a8e25'
          tenant-id: 'd08d9b64-0686-4e59-b7c5-b82b5d212a63'
          subscription-id: '9f14d6da-b117-434d-922f-f763c8ec88bb'
          
      - name: Allow PowerShell scripts to run
        run: Set-ExecutionPolicy Bypass -Scope Process -Force
        shell: powershell
        
      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        run: terraform init -input=false
      
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
      
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true
        
      # - name: Terraform Apply
      #   id: apply
      #   if: ${{ github.ref == 'refs/heads/main' }}  # only apply from main branch
      #   run: terraform apply -auto-approve tfplan

  Apply-job:
    runs-on: self-hosted
    name: apply job
    needs: planning-job
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: '9cd2e95c-0ae3-48fa-b642-ca15ee3a8e25'
          tenant-id: 'd08d9b64-0686-4e59-b7c5-b82b5d212a63'
          subscription-id: '9f14d6da-b117-434d-922f-f763c8ec88bb'         
      
      - name: Terraform Init
        id: init
        run: terraform init -input=false
        
      - name: Terraform Apply
        id: apply
        # if: ${{ github.ref == 'refs/heads/main' }}
        run: terraform apply -auto-approve
